import { VCardEncoding } from './types/vCardEncoding';
import { isPropertyWithParameters, propertyToVCardString, isPropertyWithParametersAddressValue, } from './types/parameter/BasicPropertyParameters.type';
import { nl, e } from './helpers';
export class VCardFormatter {
    static getVCardAsBlob(vCard, encoding = VCardEncoding.none) {
        const data = VCardFormatter.getVCardAsString(vCard, encoding);
        return new Blob([data], { type: 'text/vcard' });
    }
    /**
     * Get formatted vCard in VCF format
     */
    static getVCardAsString(vCard, encodingPrefix = VCardEncoding.none) {
        if (!vCard.version) {
            vCard.version = '4.0';
        }
        const majorVersion = getMajorVersion(vCard.version);
        let formattedVCardString = '';
        formattedVCardString += 'BEGIN:VCARD' + nl();
        formattedVCardString += 'VERSION:' + vCard.version + nl();
        // const encodingPrefix = '';
        let formattedName = '';
        if (vCard.name == null) {
            vCard.name = {};
        }
        let nameArray = [];
        if (vCard.formattedName != null) {
            nameArray = [vCard.formattedName.firstNames, vCard.formattedName.addtionalNames, vCard.formattedName.lastNames];
        }
        else {
            nameArray = [vCard.name.firstNames, vCard.name.addtionalNames, vCard.name.lastNames];
        }
        formattedName = nameArray.filter((string) => string != null).join(' ');
        formattedVCardString += 'FN' + encodingPrefix + ':' + e(formattedName) + nl();
        formattedVCardString +=
            'N' +
                encodingPrefix +
                ':' +
                [
                    e(vCard.name.lastNames),
                    e(vCard.name.firstNames),
                    e(vCard.name.addtionalNames),
                    e(vCard.name.namePrefix),
                    e(vCard.name.nameSuffix),
                ].join(';') +
                nl();
        if (vCard.nickname && majorVersion >= 3) {
            formattedVCardString += 'NICKNAME' + encodingPrefix + ':' + e(vCard.nickname) + nl();
        }
        if (vCard.gender) {
            if (vCard.gender.sex) {
                formattedVCardString += 'GENDER:' + e(vCard.gender.sex);
                if (vCard.gender.text) {
                    formattedVCardString += ';' + e(vCard.gender.text);
                }
                formattedVCardString += nl();
            }
            else {
                formattedVCardString += 'GENDER:;' + e(vCard.gender.text) + nl();
            }
        }
        if (vCard.uid) {
            formattedVCardString += 'UID' + encodingPrefix + ':' + e(vCard.uid) + nl();
        }
        if (vCard.birthday) {
            formattedVCardString += 'BDAY:' + YYYYMMDD(vCard.birthday) + nl();
        }
        if (vCard.anniversary) {
            formattedVCardString += 'ANNIVERSARY:' + YYYYMMDD(vCard.anniversary) + nl();
        }
        if (vCard.language) {
            vCard.language.forEach((language) => {
                if (isPropertyWithParameters(language)) {
                    formattedVCardString += 'LANG' + propertyToVCardString(language.param) + ':' + e(language.value) + nl();
                }
                else {
                    formattedVCardString += 'LANG:' + e(language) + nl();
                }
            });
        }
        if (vCard.organization) {
            if (isPropertyWithParameters(vCard.organization)) {
                formattedVCardString +=
                    'ORG' + propertyToVCardString(vCard.organization.param) + ':' + e(vCard.organization.value) + nl();
            }
            else {
                formattedVCardString += 'ORG' + encodingPrefix + ':' + e(vCard.organization) + nl();
            }
        }
        if (vCard.address) {
            vCard.address.forEach((address) => {
                if (isPropertyWithParametersAddressValue(address)) {
                    formattedVCardString +=
                        'ADR' +
                            propertyToVCardString(address.param) +
                            getFormattedAddress(address.value) +
                            nl();
                }
                else {
                    formattedVCardString += 'ADR' + getFormattedAddress(address) + nl();
                }
            });
        }
        if (vCard.telephone) {
            vCard.telephone.forEach((element) => {
                if (!isPropertyWithParameters(element)) {
                    element = {
                        value: element,
                        param: {
                            type: 'voice',
                        },
                    };
                }
                formattedVCardString +=
                    'TEL' + propertyToVCardString(element.param) + ':' + e(element.value) + nl();
            });
        }
        if (vCard.email) {
            vCard.email.forEach((email) => {
                if (isPropertyWithParameters(email)) {
                    formattedVCardString += 'EMAIL' + propertyToVCardString(email.param) + ':' + e(email.value) + nl();
                }
                else {
                    formattedVCardString += 'EMAIL:' + e(email) + nl();
                }
            });
        }
        if (vCard.title) {
            formattedVCardString += 'TITLE' + encodingPrefix + ':' + e(vCard.title) + nl();
        }
        if (vCard.logo) {
            if (isPropertyWithParameters(vCard.logo)) {
                formattedVCardString += 'LOGO' + propertyToVCardString(vCard.logo.param) + ':' + e(vCard.logo.value) + nl();
            }
            else {
                formattedVCardString += 'LOGO:' + e(vCard.logo) + nl();
            }
        }
        if (vCard.photo) {
            if (isPropertyWithParameters(vCard.photo)) {
                formattedVCardString += 'PHOTO' + propertyToVCardString(vCard.photo.param) + ':' + e(vCard.photo.value) + nl();
            }
            else {
                formattedVCardString += 'PHOTO:' + e(vCard.photo) + nl();
            }
        }
        if (vCard.homeFax) {
            vCard.homeFax.forEach(function (number) {
                if (+majorVersion >= 4) {
                    formattedVCardString += 'TEL;VALUE=uri;TYPE="fax,home":tel:' + e(number) + nl();
                }
                else {
                    formattedVCardString += 'TEL;TYPE=HOME,FAX:' + e(number) + nl();
                }
            });
        }
        if (vCard.workFax) {
            vCard.workFax.forEach(function (number) {
                if (+majorVersion >= 4) {
                    formattedVCardString += 'TEL;VALUE=uri;TYPE="fax,work":tel:' + e(number) + nl();
                }
                else {
                    formattedVCardString += 'TEL;TYPE=WORK,FAX:' + e(number) + nl();
                }
            });
        }
        if (vCard.role) {
            formattedVCardString += 'ROLE' + encodingPrefix + ':' + e(vCard.role) + nl();
        }
        if (vCard.url) {
            let urlNotSet = true;
            if (hasProp(vCard.url, 'home')) {
                formattedVCardString += 'URL;type=WORK' + encodingPrefix + ':' + e(vCard.url.home) + nl();
                urlNotSet = false;
            }
            if (hasProp(vCard.url, 'work')) {
                formattedVCardString += 'URL;type=WORK' + encodingPrefix + ':' + e(vCard.url.work) + nl();
                urlNotSet = false;
            }
            if (urlNotSet) {
                formattedVCardString += 'URL' + encodingPrefix + ':' + e(vCard.url) + nl();
            }
        }
        if (vCard.note) {
            formattedVCardString += 'NOTE' + encodingPrefix + ':' + e(vCard.note) + nl();
        }
        if (vCard.socialUrls) {
            for (const key in vCard.socialUrls) {
                if (vCard.socialUrls.hasOwnProperty(key) && vCard.socialUrls[key]) {
                    formattedVCardString +=
                        'X-SOCIALPROFILE' + encodingPrefix + ';TYPE=' + key + ':' + e(vCard.socialUrls[key]) + nl();
                }
            }
        }
        if (vCard.source) {
            if (isPropertyWithParameters(vCard.source)) {
                formattedVCardString +=
                    'SOURCE' + encodingPrefix + propertyToVCardString(vCard.source.param) + ':' + e(vCard.source.value) + +nl();
            }
            else {
                formattedVCardString += 'SOURCE' + encodingPrefix + ':' + e(vCard.source) + nl();
            }
        }
        if (vCard.rev) {
            formattedVCardString += 'REV:' + vCard.rev + nl();
        }
        formattedVCardString += 'END:VCARD' + nl();
        return formattedVCardString;
    }
}
/**
 * Get formatted photo
 * @param photoType       Photo type (PHOTO, LOGO)
 * @param url             URL to attach photo from
 * @param mediaType       Media-type of photo (JPEG, PNG, GIF)
 */
function getFormattedPhoto(photoType, url, mediaType, base64, majorVersion) {
    let params;
    if (+majorVersion >= 4) {
        params = base64 ? ';ENCODING=b;MEDIATYPE=image/' : ';MEDIATYPE=image/';
    }
    else if (+majorVersion === 3) {
        params = base64 ? ';ENCODING=b;TYPE=' : ';TYPE=';
    }
    else {
        params = base64 ? ';ENCODING=BASE64;' : ';';
    }
    const formattedPhoto = photoType + params + mediaType + ':' + e(url) + nl();
    return formattedPhoto;
}
/**
 * Get formatted address
 */
function getFormattedAddress(address) {
    return ((address.label ? ';LABEL="' + e(address.label) + '"' : '') +
        ':' +
        e(address.postOfficeBox) +
        ';' +
        e(address.extendedAddress) +
        ';' +
        e(address.street) +
        ';' +
        e(address.locality) +
        ';' +
        e(address.region) +
        ';' +
        e(address.postalCode) +
        ';' +
        e(address.countryName));
}
/**
 * Convert date to YYYYMMDD format
 */
function YYYYMMDD(date) {
    if (!date) {
        return '';
    }
    return date.toLocaleDateString('se').replace(/\D/g, ''); // use Swedish date format
}
/**
 * Get major version from version string
 */
export function getMajorVersion(version) {
    const majorVersionString = version ? version.slice(0, 1) : '4';
    if (!isNaN(+majorVersionString)) {
        return Number.parseInt(majorVersionString);
    }
    return 4;
}
/**
 * Determines if the object has the Property
 * @param obj Object to test
 * @param property Property to check
 */
function hasProp(obj, property) {
    return Object.prototype.hasOwnProperty.call(obj, property);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXZjYXJkLmZvcm1hdHRlci5qcyIsInNvdXJjZVJvb3QiOiJDOi9Vc2Vycy9TdGVwaGFuaWUvRG9jdW1lbnRzL25neC12Y2FyZC9wcm9qZWN0cy9uZ3gtdmNhcmQvc3JjLyIsInNvdXJjZXMiOlsibGliL25neC12Y2FyZC5mb3JtYXR0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3RELE9BQU8sRUFDTCx3QkFBd0IsRUFDeEIscUJBQXFCLEVBRXJCLG9DQUFvQyxHQUNyQyxNQUFNLGdEQUFnRCxDQUFDO0FBQ3hELE9BQU8sRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRWxDLE1BQU0sT0FBTyxjQUFjO0lBQ2xCLE1BQU0sQ0FBQyxjQUFjLENBQUMsS0FBWSxFQUFFLFdBQTBCLGFBQWEsQ0FBQyxJQUFJO1FBQ3JGLE1BQU0sSUFBSSxHQUFHLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDOUQsT0FBTyxJQUFJLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVEOztPQUVHO0lBQ0ksTUFBTSxDQUFDLGdCQUFnQixDQUFDLEtBQVksRUFBRSxpQkFBZ0MsYUFBYSxDQUFDLElBQUk7UUFDN0YsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUU7WUFDbEIsS0FBSyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7U0FDdkI7UUFDRCxNQUFNLFlBQVksR0FBRyxlQUFlLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXBELElBQUksb0JBQW9CLEdBQUcsRUFBRSxDQUFDO1FBQzlCLG9CQUFvQixJQUFJLGFBQWEsR0FBRyxFQUFFLEVBQUUsQ0FBQztRQUM3QyxvQkFBb0IsSUFBSSxVQUFVLEdBQUcsS0FB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RDs7R0FFRztBQUNILE1BQU0sVUFBVSxlQUFlLENBQUMsT0FBZTtJQUM3QyxNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztJQUMvRCxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsa0JBQWtCLENBQUMsRUFBRTtRQUMvQixPQUFPLE1BQU0sQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsQ0FBQztLQUM1QztJQUNELE9BQU8sQ0FBQyxDQUFDO0FBQ1gsQ0FBQztBQUVEOzs7O0dBSUc7QUFDSCxTQUFTLE9BQU8sQ0FBQyxHQUFRLEVBQUUsUUFBZ0I7SUFDekMsT0FBTyxNQUFNLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQzdELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBWQ2FyZCwgQWRkcmVzcyB9IGZyb20gJy4vdHlwZXMvdkNhcmQnO1xyXG5pbXBvcnQgeyBWQ2FyZEVuY29kaW5nIH0gZnJvbSAnLi90eXBlcy92Q2FyZEVuY29kaW5nJztcclxuaW1wb3J0IHtcclxuICBpc1Byb3BlcnR5V2l0aFBhcmFtZXRlcnMsXHJcbiAgcHJvcGVydHlUb1ZDYXJkU3RyaW5nLFxyXG4gIEJhc2ljUHJvcGVydHlQYXJhbWV0ZXJzLFxyXG4gIGlzUHJvcGVydHlXaXRoUGFyYW1ldGVyc0FkZHJlc3NWYWx1ZSxcclxufSBmcm9tICcuL3R5cGVzL3BhcmFtZXRlci9CYXNpY1Byb3BlcnR5UGFyYW1ldGVycy50eXBlJztcclxuaW1wb3J0IHsgbmwsIGUgfSBmcm9tICcuL2hlbHBlcnMnO1xyXG5cclxuZXhwb3J0IGNsYXNzIFZDYXJkRm9ybWF0dGVyIHtcclxuICBwdWJsaWMgc3RhdGljIGdldFZDYXJkQXNCbG9iKHZDYXJkOiBWQ2FyZCwgZW5jb2Rpbmc6IFZDYXJkRW5jb2RpbmcgPSBWQ2FyZEVuY29kaW5nLm5vbmUpOiBCbG9iIHtcclxuICAgIGNvbnN0IGRhdGEgPSBWQ2FyZEZvcm1hdHRlci5nZXRWQ2FyZEFzU3RyaW5nKHZDYXJkLCBlbmNvZGluZyk7XHJcbiAgICByZXR1cm4gbmV3IEJsb2IoW2RhdGFdLCB7IHR5cGU6ICd0ZXh0L3ZjYXJkJyB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCBmb3JtYXR0ZWQgdkNhcmQgaW4gVkNGIGZvcm1hdFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0aWMgZ2V0VkNhcmRBc1N0cmluZyh2Q2FyZDogVkNhcmQsIGVuY29kaW5nUHJlZml4OiBWQ2FyZEVuY29kaW5nID0gVkNhcmRFbmNvZGluZy5ub25lKTogc3RyaW5nIHtcclxuICAgIGlmICghdkNhcmQudmVyc2lvbikge1xyXG4gICAgICB2Q2FyZC52ZXJzaW9uID0gJzQuMCc7XHJcbiAgICB9XHJcbiAgICBjb25zdCBtYWpvclZlcnNpb24gPSBnZXRNYWpvclZlcnNpb24odkNhcmQudmVyc2lvbik7XHJcblxyXG4gICAgbGV0IGZvcm1hdHRlZFZDYXJkU3RyaW5nID0gJyc7XHJcbiAgICBmb3JtYXR0ZWRWQ2FyZFN0cmluZyArPSAnQkVHSU46VkNBUkQnICsgbmwoKTtcclxuICAgIGZvcm1hdHRlZFZDYXJkU3RyaW5nICs9ICdWRVJTSU9OOicgKyB2Q2FyZC52ZXJzaW9uICsgbmwoKTtcclxuXHJcbiAgICAvLyBjb25zdCBlbmNvZGluZ1ByZWZpeCA9ICcnO1xyXG4gICAgbGV0IGZvcm1hdHRlZE5hbWUgPSAnJztcclxuICAgIGlmICh2Q2FyZC5uYW1lID09IG51bGwpIHtcclxuICAgICAgdkNhcmQubmFtZSA9IHt9O1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBuYW1lQXJyYXkgPSBbXTtcclxuICAgIGlmICh2Q2FyZC5mb3JtYXR0ZWROYW1lICE9IG51bGwpIHtcclxuICAgICAgbmFtZUFycmF5ID0gW3ZDYXJkLmZvcm1hdHRlZE5hbWUuZmlyc3ROYW1lcywgdkNhcmQuZm9ybWF0dGVkTmFtZS5hZGR0aW9uYWxOYW1lcywgdkNhcmQuZm9ybWF0dGVkTmFtZS5sYXN0TmFtZXNdO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbmFtZUFycmF5ID0gW3ZDYXJkLm5hbWUuZmlyc3ROYW1lcywgdkNhcmQubmFtZS5hZGR0aW9uYWxOYW1lcywgdkNhcmQubmFtZS5sYXN0TmFtZXNdO1xyXG4gICAgfVxyXG5cclxuICAgIGZvcm1hdHRlZE5hbWUgPSBuYW1lQXJyYXkuZmlsdGVyKChzdHJpbmcpID0+IHN0cmluZyAhPSBudWxsKS5qb2luKCcgJyk7XHJcblxyXG4gICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz0gJ0ZOJyArIGVuY29kaW5nUHJlZml4ICsgJzonICsgZShmb3JtYXR0ZWROYW1lKSArIG5sKCk7XHJcblxyXG4gICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz1cclxuICAgICAgJ04nICtcclxuICAgICAgZW5jb2RpbmdQcmVmaXggK1xyXG4gICAgICAnOicgK1xyXG4gICAgICBbXHJcbiAgICAgICAgZSh2Q2FyZC5uYW1lLmxhc3ROYW1lcyksXHJcbiAgICAgICAgZSh2Q2FyZC5uYW1lLmZpcnN0TmFtZXMpLFxyXG4gICAgICAgIGUodkNhcmQubmFtZS5hZGR0aW9uYWxOYW1lcyksXHJcbiAgICAgICAgZSh2Q2FyZC5uYW1lLm5hbWVQcmVmaXgpLFxyXG4gICAgICAgIGUodkNhcmQubmFtZS5uYW1lU3VmZml4KSxcclxuICAgICAgXS5qb2luKCc7JykgK1xyXG4gICAgICBubCgpO1xyXG5cclxuICAgIGlmICh2Q2FyZC5uaWNrbmFtZSAmJiBtYWpvclZlcnNpb24gPj0gMykge1xyXG4gICAgICBmb3JtYXR0ZWRWQ2FyZFN0cmluZyArPSAnTklDS05BTUUnICsgZW5jb2RpbmdQcmVmaXggKyAnOicgKyBlKHZDYXJkLm5pY2tuYW1lKSArIG5sKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHZDYXJkLmdlbmRlcikge1xyXG4gICAgICBpZiAodkNhcmQuZ2VuZGVyLnNleCkge1xyXG4gICAgICAgIGZvcm1hdHRlZFZDYXJkU3RyaW5nICs9ICdHRU5ERVI6JyArIGUodkNhcmQuZ2VuZGVyLnNleCk7XHJcbiAgICAgICAgaWYgKHZDYXJkLmdlbmRlci50ZXh0KSB7XHJcbiAgICAgICAgICBmb3JtYXR0ZWRWQ2FyZFN0cmluZyArPSAnOycgKyBlKHZDYXJkLmdlbmRlci50ZXh0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz0gbmwoKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBmb3JtYXR0ZWRWQ2FyZFN0cmluZyArPSAnR0VOREVSOjsnICsgZSh2Q2FyZC5nZW5kZXIudGV4dCkgKyBubCgpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHZDYXJkLnVpZCkge1xyXG4gICAgICBmb3JtYXR0ZWRWQ2FyZFN0cmluZyArPSAnVUlEJyArIGVuY29kaW5nUHJlZml4ICsgJzonICsgZSh2Q2FyZC51aWQpICsgbmwoKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodkNhcmQuYmlydGhkYXkpIHtcclxuICAgICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz0gJ0JEQVk6JyArIFlZWVlNTUREKHZDYXJkLmJpcnRoZGF5KSArIG5sKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHZDYXJkLmFubml2ZXJzYXJ5KSB7XHJcbiAgICAgIGZvcm1hdHRlZFZDYXJkU3RyaW5nICs9ICdBTk5JVkVSU0FSWTonICsgWVlZWU1NREQodkNhcmQuYW5uaXZlcnNhcnkpICsgbmwoKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodkNhcmQubGFuZ3VhZ2UpIHtcclxuICAgICAgdkNhcmQubGFuZ3VhZ2UuZm9yRWFjaCgobGFuZ3VhZ2UpID0+IHtcclxuICAgICAgICBpZiAoaXNQcm9wZXJ0eVdpdGhQYXJhbWV0ZXJzKGxhbmd1YWdlKSkge1xyXG4gICAgICAgICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz0gJ0xBTkcnICsgcHJvcGVydHlUb1ZDYXJkU3RyaW5nKGxhbmd1YWdlLnBhcmFtKSArICc6JyArIGUobGFuZ3VhZ2UudmFsdWUpICsgbmwoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz0gJ0xBTkc6JyArIGUobGFuZ3VhZ2UpICsgbmwoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh2Q2FyZC5vcmdhbml6YXRpb24pIHtcclxuICAgICAgaWYgKGlzUHJvcGVydHlXaXRoUGFyYW1ldGVycyh2Q2FyZC5vcmdhbml6YXRpb24pKSB7XHJcbiAgICAgICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz1cclxuICAgICAgICAgICdPUkcnICsgcHJvcGVydHlUb1ZDYXJkU3RyaW5nKHZDYXJkLm9yZ2FuaXphdGlvbi5wYXJhbSkgKyAnOicgKyBlKHZDYXJkLm9yZ2FuaXphdGlvbi52YWx1ZSkgKyBubCgpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGZvcm1hdHRlZFZDYXJkU3RyaW5nICs9ICdPUkcnICsgZW5jb2RpbmdQcmVmaXggKyAnOicgKyBlKHZDYXJkLm9yZ2FuaXphdGlvbikgKyBubCgpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHZDYXJkLmFkZHJlc3MpIHtcclxuICAgICAgdkNhcmQuYWRkcmVzcy5mb3JFYWNoKChhZGRyZXNzKSA9PiB7XHJcbiAgICAgICAgaWYgKGlzUHJvcGVydHlXaXRoUGFyYW1ldGVyc0FkZHJlc3NWYWx1ZShhZGRyZXNzKSkge1xyXG4gICAgICAgICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz1cclxuICAgICAgICAgICAgJ0FEUicgK1xyXG4gICAgICAgICAgICBwcm9wZXJ0eVRvVkNhcmRTdHJpbmcoYWRkcmVzcy5wYXJhbSBhcyBCYXNpY1Byb3BlcnR5UGFyYW1ldGVycykgK1xyXG4gICAgICAgICAgICBnZXRGb3JtYXR0ZWRBZGRyZXNzKGFkZHJlc3MudmFsdWUpICtcclxuICAgICAgICAgICAgbmwoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz0gJ0FEUicgKyBnZXRGb3JtYXR0ZWRBZGRyZXNzKGFkZHJlc3MpICsgbmwoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh2Q2FyZC50ZWxlcGhvbmUpIHtcclxuICAgICAgdkNhcmQudGVsZXBob25lLmZvckVhY2goKGVsZW1lbnQpID0+IHtcclxuICAgICAgICBpZiAoIWlzUHJvcGVydHlXaXRoUGFyYW1ldGVycyhlbGVtZW50KSkge1xyXG4gICAgICAgICAgZWxlbWVudCA9IHtcclxuICAgICAgICAgICAgdmFsdWU6IGVsZW1lbnQsXHJcbiAgICAgICAgICAgIHBhcmFtOiB7XHJcbiAgICAgICAgICAgICAgdHlwZTogJ3ZvaWNlJyxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvcm1hdHRlZFZDYXJkU3RyaW5nICs9XHJcbiAgICAgICAgICAnVEVMJyArIHByb3BlcnR5VG9WQ2FyZFN0cmluZyhlbGVtZW50LnBhcmFtIGFzIEJhc2ljUHJvcGVydHlQYXJhbWV0ZXJzKSArICc6JyArIGUoZWxlbWVudC52YWx1ZSkgKyBubCgpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodkNhcmQuZW1haWwpIHtcclxuICAgICAgdkNhcmQuZW1haWwuZm9yRWFjaCgoZW1haWwpID0+IHtcclxuICAgICAgICBpZiAoaXNQcm9wZXJ0eVdpdGhQYXJhbWV0ZXJzKGVtYWlsKSkge1xyXG4gICAgICAgICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz0gJ0VNQUlMJyArIHByb3BlcnR5VG9WQ2FyZFN0cmluZyhlbWFpbC5wYXJhbSkgKyAnOicgKyBlKGVtYWlsLnZhbHVlKSArIG5sKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGZvcm1hdHRlZFZDYXJkU3RyaW5nICs9ICdFTUFJTDonICsgZShlbWFpbCkgKyBubCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHZDYXJkLnRpdGxlKSB7XHJcbiAgICAgIGZvcm1hdHRlZFZDYXJkU3RyaW5nICs9ICdUSVRMRScgKyBlbmNvZGluZ1ByZWZpeCArICc6JyArIGUodkNhcmQudGl0bGUpICsgbmwoKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodkNhcmQubG9nbykge1xyXG4gICAgICBpZiAoaXNQcm9wZXJ0eVdpdGhQYXJhbWV0ZXJzKHZDYXJkLmxvZ28pKSB7XHJcbiAgICAgICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz0gJ0xPR08nICsgcHJvcGVydHlUb1ZDYXJkU3RyaW5nKHZDYXJkLmxvZ28ucGFyYW0pICsgJzonICsgZSh2Q2FyZC5sb2dvLnZhbHVlKSArIG5sKCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz0gJ0xPR086JyArIGUodkNhcmQubG9nbykgKyBubCgpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHZDYXJkLnBob3RvKSB7XHJcbiAgICAgIGlmIChpc1Byb3BlcnR5V2l0aFBhcmFtZXRlcnModkNhcmQucGhvdG8pKSB7XHJcbiAgICAgICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz0gJ1BIT1RPJyArIHByb3BlcnR5VG9WQ2FyZFN0cmluZyh2Q2FyZC5waG90by5wYXJhbSkgKyAnOicgKyBlKHZDYXJkLnBob3RvLnZhbHVlKSArIG5sKCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz0gJ1BIT1RPOicgKyBlKHZDYXJkLnBob3RvKSArIG5sKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAodkNhcmQuaG9tZUZheCkge1xyXG4gICAgICB2Q2FyZC5ob21lRmF4LmZvckVhY2goZnVuY3Rpb24gKG51bWJlcikge1xyXG4gICAgICAgIGlmICgrbWFqb3JWZXJzaW9uID49IDQpIHtcclxuICAgICAgICAgIGZvcm1hdHRlZFZDYXJkU3RyaW5nICs9ICdURUw7VkFMVUU9dXJpO1RZUEU9XCJmYXgsaG9tZVwiOnRlbDonICsgZShudW1iZXIpICsgbmwoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz0gJ1RFTDtUWVBFPUhPTUUsRkFYOicgKyBlKG51bWJlcikgKyBubCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHZDYXJkLndvcmtGYXgpIHtcclxuICAgICAgdkNhcmQud29ya0ZheC5mb3JFYWNoKGZ1bmN0aW9uIChudW1iZXIpIHtcclxuICAgICAgICBpZiAoK21ham9yVmVyc2lvbiA+PSA0KSB7XHJcbiAgICAgICAgICBmb3JtYXR0ZWRWQ2FyZFN0cmluZyArPSAnVEVMO1ZBTFVFPXVyaTtUWVBFPVwiZmF4LHdvcmtcIjp0ZWw6JyArIGUobnVtYmVyKSArIG5sKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGZvcm1hdHRlZFZDYXJkU3RyaW5nICs9ICdURUw7VFlQRT1XT1JLLEZBWDonICsgZShudW1iZXIpICsgbmwoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh2Q2FyZC5yb2xlKSB7XHJcbiAgICAgIGZvcm1hdHRlZFZDYXJkU3RyaW5nICs9ICdST0xFJyArIGVuY29kaW5nUHJlZml4ICsgJzonICsgZSh2Q2FyZC5yb2xlKSArIG5sKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHZDYXJkLnVybCkge1xyXG4gICAgICBsZXQgdXJsTm90U2V0ID0gdHJ1ZTtcclxuICAgICAgaWYgKGhhc1Byb3AodkNhcmQudXJsLCAnaG9tZScpKSB7XHJcbiAgICAgICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz0gJ1VSTDt0eXBlPVdPUksnICsgZW5jb2RpbmdQcmVmaXggKyAnOicgKyBlKCh2Q2FyZC51cmwgYXMgeyBob21lOiBzdHJpbmcgfSkuaG9tZSkgKyBubCgpO1xyXG4gICAgICAgIHVybE5vdFNldCA9IGZhbHNlO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoaGFzUHJvcCh2Q2FyZC51cmwsICd3b3JrJykpIHtcclxuICAgICAgICBmb3JtYXR0ZWRWQ2FyZFN0cmluZyArPSAnVVJMO3R5cGU9V09SSycgKyBlbmNvZGluZ1ByZWZpeCArICc6JyArIGUoKHZDYXJkLnVybCBhcyB7IHdvcms6IHN0cmluZyB9KS53b3JrKSArIG5sKCk7XHJcbiAgICAgICAgdXJsTm90U2V0ID0gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHVybE5vdFNldCkge1xyXG4gICAgICAgIGZvcm1hdHRlZFZDYXJkU3RyaW5nICs9ICdVUkwnICsgZW5jb2RpbmdQcmVmaXggKyAnOicgKyBlKHZDYXJkLnVybCBhcyBzdHJpbmcpICsgbmwoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmICh2Q2FyZC5ub3RlKSB7XHJcbiAgICAgIGZvcm1hdHRlZFZDYXJkU3RyaW5nICs9ICdOT1RFJyArIGVuY29kaW5nUHJlZml4ICsgJzonICsgZSh2Q2FyZC5ub3RlKSArIG5sKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHZDYXJkLnNvY2lhbFVybHMpIHtcclxuICAgICAgZm9yIChjb25zdCBrZXkgaW4gdkNhcmQuc29jaWFsVXJscykge1xyXG4gICAgICAgIGlmICh2Q2FyZC5zb2NpYWxVcmxzLmhhc093blByb3BlcnR5KGtleSkgJiYgdkNhcmQuc29jaWFsVXJsc1trZXldKSB7XHJcbiAgICAgICAgICBmb3JtYXR0ZWRWQ2FyZFN0cmluZyArPVxyXG4gICAgICAgICAgICAnWC1TT0NJQUxQUk9GSUxFJyArIGVuY29kaW5nUHJlZml4ICsgJztUWVBFPScgKyBrZXkgKyAnOicgKyBlKHZDYXJkLnNvY2lhbFVybHNba2V5XSkgKyBubCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmICh2Q2FyZC5zb3VyY2UpIHtcclxuICAgICAgaWYgKGlzUHJvcGVydHlXaXRoUGFyYW1ldGVycyh2Q2FyZC5zb3VyY2UpKSB7XHJcbiAgICAgICAgZm9ybWF0dGVkVkNhcmRTdHJpbmcgKz1cclxuICAgICAgICAgICdTT1VSQ0UnICsgZW5jb2RpbmdQcmVmaXggKyBwcm9wZXJ0eVRvVkNhcmRTdHJpbmcodkNhcmQuc291cmNlLnBhcmFtKSArICc6JyArIGUodkNhcmQuc291cmNlLnZhbHVlKSArICtubCgpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGZvcm1hdHRlZFZDYXJkU3RyaW5nICs9ICdTT1VSQ0UnICsgZW5jb2RpbmdQcmVmaXggKyAnOicgKyBlKHZDYXJkLnNvdXJjZSkgKyBubCgpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAodkNhcmQucmV2KSB7XHJcbiAgICAgIGZvcm1hdHRlZFZDYXJkU3RyaW5nICs9ICdSRVY6JyArIHZDYXJkLnJldiArIG5sKCk7XHJcbiAgICB9XHJcbiAgICBmb3JtYXR0ZWRWQ2FyZFN0cmluZyArPSAnRU5EOlZDQVJEJyArIG5sKCk7XHJcbiAgICByZXR1cm4gZm9ybWF0dGVkVkNhcmRTdHJpbmc7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogR2V0IGZvcm1hdHRlZCBwaG90b1xyXG4gKiBAcGFyYW0gcGhvdG9UeXBlICAgICAgIFBob3RvIHR5cGUgKFBIT1RPLCBMT0dPKVxyXG4gKiBAcGFyYW0gdXJsICAgICAgICAgICAgIFVSTCB0byBhdHRhY2ggcGhvdG8gZnJvbVxyXG4gKiBAcGFyYW0gbWVkaWFUeXBlICAgICAgIE1lZGlhLXR5cGUgb2YgcGhvdG8gKEpQRUcsIFBORywgR0lGKVxyXG4gKi9cclxuZnVuY3Rpb24gZ2V0Rm9ybWF0dGVkUGhvdG8oXHJcbiAgcGhvdG9UeXBlOiAnUEhPVE8nIHwgJ0xPR08nLFxyXG4gIHVybDogc3RyaW5nLFxyXG4gIG1lZGlhVHlwZTogc3RyaW5nLFxyXG4gIGJhc2U2NDogYm9vbGVhbixcclxuICBtYWpvclZlcnNpb246IG51bWJlclxyXG4pIHtcclxuICBsZXQgcGFyYW1zO1xyXG5cclxuICBpZiAoK21ham9yVmVyc2lvbiA+PSA0KSB7XHJcbiAgICBwYXJhbXMgPSBiYXNlNjQgPyAnO0VOQ09ESU5HPWI7TUVESUFUWVBFPWltYWdlLycgOiAnO01FRElBVFlQRT1pbWFnZS8nO1xyXG4gIH0gZWxzZSBpZiAoK21ham9yVmVyc2lvbiA9PT0gMykge1xyXG4gICAgcGFyYW1zID0gYmFzZTY0ID8gJztFTkNPRElORz1iO1RZUEU9JyA6ICc7VFlQRT0nO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBwYXJhbXMgPSBiYXNlNjQgPyAnO0VOQ09ESU5HPUJBU0U2NDsnIDogJzsnO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgZm9ybWF0dGVkUGhvdG8gPSBwaG90b1R5cGUgKyBwYXJhbXMgKyBtZWRpYVR5cGUgKyAnOicgKyBlKHVybCkgKyBubCgpO1xyXG4gIHJldHVybiBmb3JtYXR0ZWRQaG90bztcclxufVxyXG5cclxuLyoqXHJcbiAqIEdldCBmb3JtYXR0ZWQgYWRkcmVzc1xyXG4gKi9cclxuZnVuY3Rpb24gZ2V0Rm9ybWF0dGVkQWRkcmVzcyhhZGRyZXNzOiBBZGRyZXNzKSB7XHJcbiAgcmV0dXJuIChcclxuICAgIChhZGRyZXNzLmxhYmVsID8gJztMQUJFTD1cIicgKyBlKGFkZHJlc3MubGFiZWwpICsgJ1wiJyA6ICcnKSArXHJcbiAgICAnOicgK1xyXG4gICAgZShhZGRyZXNzLnBvc3RPZmZpY2VCb3gpICtcclxuICAgICc7JyArXHJcbiAgICBlKGFkZHJlc3MuZXh0ZW5kZWRBZGRyZXNzKSArXHJcbiAgICAnOycgK1xyXG4gICAgZShhZGRyZXNzLnN0cmVldCkgK1xyXG4gICAgJzsnICtcclxuICAgIGUoYWRkcmVzcy5sb2NhbGl0eSkgK1xyXG4gICAgJzsnICtcclxuICAgIGUoYWRkcmVzcy5yZWdpb24pICtcclxuICAgICc7JyArXHJcbiAgICBlKGFkZHJlc3MucG9zdGFsQ29kZSkgK1xyXG4gICAgJzsnICtcclxuICAgIGUoYWRkcmVzcy5jb3VudHJ5TmFtZSlcclxuICApO1xyXG59XHJcblxyXG4vKipcclxuICogQ29udmVydCBkYXRlIHRvIFlZWVlNTUREIGZvcm1hdFxyXG4gKi9cclxuZnVuY3Rpb24gWVlZWU1NREQoZGF0ZTogRGF0ZSB8IHVuZGVmaW5lZCk6IHN0cmluZyB7XHJcbiAgaWYgKCFkYXRlKSB7XHJcbiAgICByZXR1cm4gJyc7XHJcbiAgfVxyXG4gIHJldHVybiBkYXRlLnRvTG9jYWxlRGF0ZVN0cmluZygnc2UnKS5yZXBsYWNlKC9cXEQvZywgJycpOyAvLyB1c2UgU3dlZGlzaCBkYXRlIGZvcm1hdFxyXG59XHJcblxyXG4vKipcclxuICogR2V0IG1ham9yIHZlcnNpb24gZnJvbSB2ZXJzaW9uIHN0cmluZ1xyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGdldE1ham9yVmVyc2lvbih2ZXJzaW9uOiBzdHJpbmcpOiBudW1iZXIge1xyXG4gIGNvbnN0IG1ham9yVmVyc2lvblN0cmluZyA9IHZlcnNpb24gPyB2ZXJzaW9uLnNsaWNlKDAsIDEpIDogJzQnO1xyXG4gIGlmICghaXNOYU4oK21ham9yVmVyc2lvblN0cmluZykpIHtcclxuICAgIHJldHVybiBOdW1iZXIucGFyc2VJbnQobWFqb3JWZXJzaW9uU3RyaW5nKTtcclxuICB9XHJcbiAgcmV0dXJuIDQ7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBEZXRlcm1pbmVzIGlmIHRoZSBvYmplY3QgaGFzIHRoZSBQcm9wZXJ0eVxyXG4gKiBAcGFyYW0gb2JqIE9iamVjdCB0byB0ZXN0XHJcbiAqIEBwYXJhbSBwcm9wZXJ0eSBQcm9wZXJ0eSB0byBjaGVja1xyXG4gKi9cclxuZnVuY3Rpb24gaGFzUHJvcChvYmo6IGFueSwgcHJvcGVydHk6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wZXJ0eSk7XHJcbn1cclxuIl19